# jwt怎么刷新token？
* token即将过期的前5分钟，带着尚未过期的token来换取新的token。并更新用户信息表里记录的登录戳来保证本次登录token的唯一性，并可以让老的token无效。
* 失效其实是假失效。token的验证还是可以通过的。不过登录戳的验证就通不过了。所以可以保证token的唯一性。
    - 登陆戳：
    - jsonwebtoken生成新token，老token如果还没过期，是可以继续使用的。
    - 所以使用登陆戳进行校验可以让老token验证通不过。
    - 登陆戳我是存在user表中的。每次登录都修改登陆戳。
    - 登陆戳也可以用来做单设备登录。
* 打了更新token的接口之后。客户端的token也要更新。

# 刷新token的细节
* ```重点：```应该在请求成功且业务成功之后，然后判断token是否快要过期了。如果快要过期了。就刷新token。刷新失败则提示token过期了。
    - 客户端并发请求不用担心。因js是单线程。就算是异步。执行时也是有先后顺序的。
* 请求之前更新token有什么问题(有个无解的问题)？
    - 客户端并发请求时。第一个请求刷新了token。则第二个请求会验证失败。因为两次请求发送前获取的token和过期时间是一致的。
* 为什么请求成功之后更新？
    - 可以解决客户端请求并发的问题。
    - 存在问题：如果是在token的过期临界点触发了请求，会存在请求成功。刷新token失败的可能性。
    - 建议：token过期时间设置的长一点。
* 为什么请求成功之后更新token不存在客户端并发问题？
    - 第一个请求成功了。如果在客户端成功设置了新的过期时间。则第二个请求不会触发刷新token的动作。所以不用担客户端并发请求的问题。
    - 因为：虽然请求是异步的。但是js是单线程。依然有一个先后顺序。所以第一个请求成功之后一定会先设置好过期时间在客户端。
    - 此时第二个请求成功之后。去客户端读取发现过期时间是最新的。因为会判定没有过期。就不会触发刷新token的动作。
* 注意：
    - 刷新token的时候。
    - 如果走的是一个新的ajax。则需要单独处理错误以及验签等。所以建议下面这个。然后加参数控制。
    - 如果走的是封装好的ajax(封装好的里面进行了刷新token的处理，错误处理，验签处理等。如果继续走的话，相当于递归调用了)。则需要判断如果当前是打的是刷新token的接口。则成功的回调里不应该再次刷新token。
    - 建议参数名为isRefreshToken。当这个参数为false时就不刷新token。刷新token的请求里把这个参数设置成false即可。

# 交互体验
* 过期弹窗提示：登录信息已过期。去新页面登录。登录完毕再回来继续操作。
    - 直接刷新会导致当前页面用户操作了但未保存的所有数据丢失。

# 如果想像session那样自动刷新token
* 功能：session可以做每次请求都重新设置session cookie，假设你的cookie是10分钟过期，每次请求都会再设置10分钟。
* 实现：做有状态的token。第一步是生成随机token。然后用redis存储token。每次请求(所有携带了token的请求)时都重新设置token在redis上的过期时间。
    - 并不是所有请求都会携带token。所以无法完全做到像使用session时那样。
    - 思考：既然使用jsonwebtoken，就不应该把思想靠拢到session上。就应该做无状态的。不然的话直接使用session不就可以了？
    - 建议：在客户端有请求响应成功时，判断token是不是快要过期了，如果快要过期了。则刷新token。如果已经过期了。则重新登录。
