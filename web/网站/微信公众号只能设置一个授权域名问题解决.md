# 微信 UnionID 机制说明
* 如果开发者拥有多个移动应用、网站应用、和公众帐号（包括小程序）。
* 可通过 UnionID 来区分用户的唯一性。
* 因为只要是同一个微信开放平台帐号下的移动应用、网站应用和公众帐号（包括小程序），用户的 UnionID 是唯一的。
* 换句话说，同一用户，对同一个微信开放平台下的不同应用，unionid是相同的。
> 获取unionid
* 微信h5公众号开发，用户进行微信授权登陆之后，后端就可以拿code进行一系列流程拿到。
* 小程序开发，wx.login之后，后端就可以拿code进行一系列流程拿到。

# 场景
> 给innisfree做导购端小程序和导购端h5。和前公司商派那边对接。innisfree的商城系统是商派那边开发的。
* innisfree的公众号授权域名不允许再绑一个域名。
* 我们给innisfree开发的公众号h5代码还无法放到innisfree的服务器中。
  - 固无法使用innisfree公众号之前绑定的域名。
  - 本想通过二级路由的方式，突破微信公众号只能设置一个授权域名的问题。
  - 但是商派那边为了安全，不会给服务器权限，固二级路由的配置行不通。
> 于是我们使用自己的公众号去开发h5，域名也用我们自己的域名，但是怎么保证两个开发者账号下用户的 UnionID 一致呢？
* 商派那边做一个innisfree的微信授权代理服务器，使用代理服务器的域名进行微信登陆授权，授权完把 UnionID 返回给我们这边。
* 如此 UnionID 就拿到了，而小程序使用的是innisfree的小程序，固innisfree小程序的 UnionID 和我们h5公众号的 UnionID 就关联上了。
  - 必须使用innisfree的小程序，否则无法保证 UnionID 的一致。
  - 对方的商城小程序和h5是innisfree公众号下的，固对方商城的小程序和h5的 UnionID 是一致的。
  - 如此，商派那边开发的innisfree的商城小程序和商城h5就和我们这边开发的innisfree的导购小程序以及导购h5通过 UnionID 打通了用户体系。
* 通过代理服务器的域名代理进行微信登陆授权也解决了微信公众号只能设置一个授权域名的问题。
* 遇到问题：jssdk注册不了。
  - 问题1：jssdk的签名需要微信授权登陆后拿到的`access_token`去换取`jsapi_ticket`然后再根据规则生成签名。授权在代理服务器那边控制，我们拿不到`access_token`。
  - 问题2：参与签名的url的域名和配置在JS接口安全域名中域名不一致。不一致的原因，是因为我们没有权限配置。
* 解决方案：
  - 打代理服务器的接口拿`jsapi_ticket`。
  - 代理服务器在JS接口安全域名那边配一个域名给我们用。或者配一个二级路由加nginx反代指向我们自己域名下相同的二级路由。

# 微信公众号只能设置一个授权域名问题解决
> ###### 问题：微信公众号只能设置一个授权域名。授权回调域名配置规范为全域名。
> ###### 方案：使用代理服务器进行域名代理。

![图片加载中...](./images/1.png)

# 步骤
* 0、申请代理服务器的app_key和app_secret。
* 1、拿app_key和app_secret和我们的回调地址打接口，拿代理服务器的token(也可能是code，然后拿code换token，再拿token再换用户信息)和微信的授权地址。
  - 微信的授权地址参数上绑定的回调地址是代理服务器域名的回调地址。
  - 代理服务器会记录我们的回调地址，等微信授权完毕，代理服务器会对我们回调地址进行回跳。
  - 此时的token还换取不到用户信息，因为还没进行微信授权。
  - 打我们自己后端的接口，让后端去转，防止暴露app_key和app_secret。
* 2、拿到回调地址之后，跳入回调地址进行微信授权，因微信授权地址参数上的回调地址是代理服务器的回调地址，所以微信授权完会跳入代理服务器的回调地址并携带code。
* 3、代理服务器拿code换用户信息并存储。然后再跳入到我们的回调地址。
* 4、此时，我们在自己的项目中，用代理服务器的token，即可拿到用户信息。
* 5、把代理服务器的token给我们自己的后端，去换取我们项目自己的token。
  - 后端拿代理服务器的token去换取用户信息以及记录用户信息并返回我们项目自己的token。
* 6、如果代理服务器的token过期，则换取用户信息会失败(也可能用户没授权)，失败的话，清理掉代理服务器的token，重新走授权流程即可。
* 代码流程：
  - 我们自己服务器的token存在的话，则走页面流程。
  - 不存在则检测代理服务器的token存不存在。
  - 代理服务器的token也不存在则获取代理服务器的token并记录以及走授权流程。
  - 授权流程走完，会回跳回来，此时发现代理服务器的token存在则用它换取我们自己的token。
  - 换取失败了就清理掉本地记录的代理服务器token并重新获取代理服务器token并记录以及走授权流程。
  - 换取成功了，则走页面流程。
  ```
  mounted () {
    const token = Cookies.get('token') // 我们自己的token
    const proxyToken = Cookies.get('proxyToken') // 代理服务器的token

    if (token) {
      this.init() // 走入页面流程
      return
    }

    if (!proxyToken) {
      // 代理服务器的token并跳入授权流程
    } else {
      // 换取我们自己的token
      // 换取成功则走入页面流程
      // 换取失败则清理掉代理服务器的token并刷新页面重新走流程
    }
  }
  ```
  - 如果我们自己的token过期了，token全清理，并重新走流程。

# 牛逼
* 能解决开发环境无法授权的问题，因为代理服务器去授权，规避掉了开发阶段本地域名无法授权的问题。牛逼。

# 如何在本地调试微信公众号的jssdk
* 改hosts，将localhost映射成你的线上域名。
```
127.0.0.1 h5.icaodong.com
```
* 如果端口不是80，再配合nginx代理一下。或者直接把服务跑成80端口。
```
server {
    listen 80;
    server_name h5.icaodong.com;
    location / {
        proxy_pass http://127.0.0.1:3000;
    }
}
```

# 微信jssdk只能配置3个域名怎么办？
* 设置顶级域名，则所有二级域名都可使用。别人亲测可行。我测了一半感觉也行。
* 如果不能设置顶级域名，那么就设置一个统一域名，然后走二级路由。
  - 不同的项目，使用nginx映射到不同的二级路由进行访问。
  - 如果是别人(其他)的项目，别人(其他)的域名，别人(其他)的服务器，想要(只能)用我们的二级域名。也是用nginx代理即可。
    - 前后端分离(history模式)：把我们的二级路由代理到别人域名下相同的二级路由即可。 
    - 前后端不分离或前后端分离(hash模式)：把我们的二级路由代理到别人的域名即可。 
