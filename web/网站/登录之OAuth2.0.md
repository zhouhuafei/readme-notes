参考文档：http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html

参考文档：https://www.cnblogs.com/flashsun/p/7424071.html

# OAuth2.0登录
OAuth是一个关于授权（authorization）的开放网络标准，在全世界得到广泛应用，目前的版本是2.0版。

# 授权过程简单梳理
拿豆瓣的第三方授权登录之qq授权登录举例子。
* 0、去腾讯开发平台。申请授权权限。
    - 绑定域名。
    - 申请app_id和app_secret。
* 1、在豆瓣网站点击qq授权登录。
    - 回跳到qq的授权登录页面，并带上回调地址。
* 2、跳到qq的授权登录页。输入qq的账号和密码。登录之后回跳到豆瓣。
    - 回跳到豆瓣其实是回跳到豆瓣的接收code码的地址。
    - 也就是第一步中设定的回调地址。
* 3、豆瓣拿到code码之后。用app_id和app_secret以及code去换取access_token。
* 4、然后再用access_token去换取qq的用户信息。
* 5、拿到qq的用户信息之后，标记为qq授权登录进来的。存到数据库里。
* 6、剩下的就是豆瓣这边自己的操作了。例如生成jsonwebtoken返回给客户端。组织用户信息返回给客户端等。

# 疑问
* 为什么OAuth2.0中access_token不能被直接返回，code可以。
    - 因为浏览器的redirect_uri是一个不安全的信道，虽然HTTPS安全但是可能会存在浏览器的cache或者log文件中，这就给攻击者盗取access_token带来了很多机会。但authorization_code不像access_token那么敏感。因为交换access_token不仅需要authorization_code还需要认证client的身份（即app_id，app_secret等）
* 回调域名是否需要在白名单里？
    - 在白名单里可以防止任何回调域名都可以接收到code。但是如此的话，本地开发就是个问题。
    - 不在白名单里，安全问题也可以不用担心吧。毕竟还有app_id和app_secret要验证。
    - 看情况自行斟酌吧。
    
# 云起微商城的OAuth之iframe登录
* iframe的链接是第三方的授权页面。但是回跳地址是当前域名下的页面。不存在跨域行为。
* 如此，在回跳地址页面，使用window.top进行页面跳转即可。

# 单页面登录
* 个人觉得交互应该如此：
    - 1、第三方授权登录，登录的时候，跳到第三方的页面去登陆，登陆完回跳。
    - 2、因是单页面，回跳的路由应是前端路由，js获取code，然后打后端接口把code给后端，后端去打第三方的接口，拿用户信息，并返回当前应用的token。然后跳回首页或指定页面。
        - 回跳的页面路由如果是后端控制，那就后端接收code，然后去第三方获取用户信息并记录到session上。然后跳回首页或指定页面。
        - 登录的时候，要用表单的submit提交，如此才能回跳(xhr的响应，不能直接让页面重定向，需要使用js控制页面跳转)，第三方重定向到回跳地址并在地址上附加code。后端会收到一个请求，在请求中处理code即可。
        - 如果是xhr登录，则第三方只返回一个code即可，回跳(拿code换token)则由前端控制。
    - 3、拿到token就相当于登录成功了。后续打接口，把token带着即可。

# 授权交互场景
* 内嵌iframe
    - 回跳地址是前端路由，第三方负责回跳。
        - submit提交。
        - 前端拿code，打后端接口，后端拿到code，打第三方接口得到用户信息并返回token。
    - 回跳地址是后端路由，第三方负责回跳。
        - submit提交。
        - 后端拿code，打第三方接口得到用户信息并记录到session。
* 不内嵌iframe
    - 跳到第三方页面去登陆，第三方负责回跳。
        - 回跳地址是前端路由
            - submit提交。
            - 前端拿code，打后端接口，后端拿到code，打第三方接口得到用户信息并返回token。
        - 回跳地址是后端路由
            - submit提交。
            - 后端拿code，打第三方接口得到用户信息并记录到session。
    - 直接打第三方的授权接口，第三方不负责回跳，只返回一个code。
        - 回跳地址是前端路由
            - xhr提交。
            - 前端拿code，打后端接口，后端拿到code，打第三方接口得到用户信息并返回token。
        - 回跳地址是后端路由
            - xhr提交。
            - 前端拿code，打后端接口，后端拿到code，打第三方接口得到用户信息并返回token。
            - 或
            - 前端拿code，组装url进行回跳，后端拿code，打第三方接口得到用户信息并记录到session。
