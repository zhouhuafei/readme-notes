参考文档：http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html

参考文档：https://www.cnblogs.com/flashsun/p/7424071.html

# OAuth2.0登录
OAuth是一个关于授权（authorization）的开放网络标准，在全世界得到广泛应用，目前的版本是2.0版。

# 授权过程简单梳理
拿豆瓣的第三方授权登录之qq授权登录举例子。
* 0、去腾讯开发平台。申请授权权限。
    - 绑定域名。
    - 申请app_id和app_secret。
* 1、在豆瓣网站点击qq授权登录。
    - 回跳到qq的授权登录页面，并带上回调地址。
* 2、跳到qq的授权登录页。输入qq的账号和密码。登录之后回跳到豆瓣。
    - 回跳到豆瓣其实是回跳到豆瓣的接收code码的地址。
    - 也就是第一步中设定的回调地址。
* 3、豆瓣拿到code码之后。用app_id和app_secret以及code去换取access_token。
* 4、然后再用access_token去换取qq的用户信息。
* 5、拿到qq的用户信息之后，标记为qq授权登录进来的。存到数据库里。
* 6、剩下的就是豆瓣这边自己的操作了。例如生成jsonwebtoken返回给客户端。组织用户信息返回给客户端等。

# 疑问
* 为什么OAuth2.0中access_token不能被直接返回，code可以。
    - 因为浏览器的redirect_uri是一个不安全的信道，虽然HTTPS安全但是可能会存在浏览器的cache或者log文件中，这就给攻击者盗取access_token带来了很多机会。但authorization_code不像access_token那么敏感。因为交换access_token不仅需要authorization_code还需要认证client的身份（即app_id，app_secret等）
* 回调域名是否需要在白名单里？
    - 在白名单里可以防止任何回调域名都可以接收到code。但是如此的话，本地开发就是个问题。
    - 不在白名单里，安全问题也可以不用担心吧。毕竟还有app_id和app_secret要验证。
    - 看情况自行斟酌吧。
    
# 云起微商城的OAuth之内嵌iframe进行登录
* iframe的链接是第三方平台的授权页面。但是回跳地址是当前应用对应域名下的页面。不存在跨域行为。
* 如此，在回跳地址页面，使用window.top进行页面跳转即可。
* 第三方平台的登陆页是使用表单(form)自带的submit进行提交的，否则无法进行页面的重定向。
    - xhr提交只能接收到响应结果，并不会主动进行页面重定向。如果服务端返回的是重定向的结果，那么在xhr中接收到的无非就是这个结果罢了。
    - 如果使用xhr登陆，则第三方平台的登陆需要返回code码，而不是进行重定向。接收到响应的code码之后，再拿这个code码去打后端的登陆接口即可。
    - 如果第三方平台支持xhr登陆，只要满足第三方平台的登陆规则，没必要内嵌iframe进行登陆，可以直接打第三方平台的登陆接口进行登陆。

# 单页面登录
* 登录页内嵌iframe，iframe是第三方平台的登录页。
* 登陆完，页面会回跳到当前应用指定的路由，这个路由因是前端控制，所以前端要去拿code，拿到之后打后端登陆接口。
    - 后端得到code之后，带着code和第三方的accessToken去拿用户信息。
    - 拿到用户信息之后返回当前应用的token给前端。
    - 前端存储token并跳到应用对应的业务页面。

# 第三方授权登陆
* 如果是用户端的第三方授权登陆，则需要跳到第三方平台的授权登录页去登陆。可以让用户有安全感。总不在自家平台让用户输入qq的账号和密码对吧。这对用户来说很不安全。
* 如果是自家的管理系统，要用自家的用户平台账号登陆，则内嵌iframe或者直接打平台接口都可。不过我建议保持统一，跳到平台的授权登录页去登陆。
    - 自家的管理系统打用户中心的接口，是为了拿一些用户的数据，例如账号有没有到期等数据。开发环境的话，后端应是自己模拟这些数据。
