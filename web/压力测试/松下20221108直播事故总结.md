## 场景
* 8台服务器，19点开始，流量瞬间涌入。
* 云数据库cpu飙升到95%（qbs太高，查询sql，3万5次/秒）。随后逐步下降。
* 云服务器cpu飙升到100%（qbs太高，单台请求，9300次/秒）。随后逐步下降。
* 服务端接口报服务器繁忙，电话蜂拥而至。

## 决策者决策
* 临时对其中两台服务器上的应用进行节点扩容。
* 订单的限流从500/秒改为1000/秒。
* 分批重启服务器上的全部应用。

## 新的问题
* 总有某些服务器上的应用重启失败。服务端接口报服务器繁忙。

## 决策者再次决策
* 完全放开订单的限流，分批重启服务器上的全部应用。

## 新的问题
* 继续重启途中，遇到堡垒机连接不上去的问题。

## 堡垒机连接不上去的原因？
* 因应用服务器cpu跑满，导致堡垒机连接不上应用服务器。

## 应用服务器的cpu为什么会跑满？
* 怀疑是因为放开了限流。
* 怀疑是增加了应用节点。

## 如何解决应用服务器cpu跑满的问题？
* 重启应用服务器。

## 决策者再次决策
* 订单的限流从完全放开改回1000。
* 下掉那两台服务器上增加的应用节点。
* 重启全部服务器。

## 什么时候恢复的稳定？
* 24点之后，流量变少了。

## 与前几次直播对比？
* 前几次直播，流量没有这么大。
* 0613直播已知数据：服务器qbs最高5500，服务器繁忙了30分钟后，自己正常了。
* 1108直播已知数据：服务器qbs最高9300，服务器繁忙了3个小时。

## 反思
* 活动期间，不要想着，靠临时改代码重新发版解决问题。
* 服务器繁忙是因为限流。改限流文案。改为`当前访问人数过多，请稍后再试`。

## 下次直播时应该怎么做？
* 活动期间，用户行为轨迹，只记录登陆即可。防止MQ队列堵塞，防止数据库频繁插入数据。
* 如果是因为限流导致，要么不管，要么继续增加服务器。
* 如果应用没有崩溃，就不要去重启应用，就不要去重启应用，就不要去重启应用。
