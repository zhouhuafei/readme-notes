## 压力测试 - jmeter

#### Jmeter 线程数、Ramp-Up时间（秒）、循环次数 都是什么意思？
* https://blog.csdn.net/yu97271486/article/details/122991051
* 测试场景：假设我开了一家店。店里有很多台自助结算终端。
  - 线程数：100。可以理解为店外有100个客户（100个线程）。
  - Ramp-up时间（秒）：10。可以理解为这100个客户，用了10秒全部进店了（启动100个线程用时10秒）。
  - 循环次数：10。可以理解为客户结算完一次后（各结各的），接着结算下一次，直到结算了10次（单个线程进行串行请求10次，注意是串行，而非并行）。
  - 调度器：勾选。可以理解为客户结算完一次后（各结各的），接着结算下一次，直到结算了10秒（单个线程进行串行请求10次，注意是串行，而非并行）。
    - 循环次数：勾选永远。
    - 持续时间（秒）：10。
* 并发测试：如果100个客户同时进行结算，我的店能应付过来么？
* 压力测试：如果100个客户同时进行结算，谁先结算完一次，谁就接着结算下一次，直到结算了10次（或10秒），我的店能应付过来么？
#### 观察哪些数据？
* 看错误率：观察服务器处理这些请求时是否出现了错误，出现错误则表示遇到瓶颈。没出错则提升参数继续进行测试，直到出现错误。
* 看吞吐量：观察服务器每秒能处理多少条请求。
  - 吞吐量和电脑的配置有关，电脑配置越高（自助结算终端越多），吞吐量越高。建议提高电脑配置（提升自助结算终端数量）。
  - 吞吐量和程序的性能有关，程序性能越高（自助结算终端越快），吞吐量越高。建议使用好的程序（提升自助结算终端速度）。
#### 测试注意事项？
* 每次测试之前，都要清除掉上次测试的聚合报告，特别是改了配置之后，否则聚合报告的样本会进行累积，导致当前次测试的聚合报告不准确。
* 尽可能的根据真实且有效的场景进行压测。
* 建议趁夜里2-6点压正式环境。测试环境再怎么真实也不是真正的正式环境。

## 场景
#### 场景1：模拟100个用户，同时点击了一下图片验证码的刷新按钮。
> 并发测试：提升用户数
* 配置：
  - 线程数：100
  - Ramp-up时间（秒）：1
  - 循环次数：1
* 讲解：1秒启动100个线程，100个线程同时发起请求，每个线程每次发1条请求。

#### 场景2：模拟100个用户，同时点击了一下图片验证码的刷新按钮。当他们对应的的验证码刷出来之后，他们又进行了下一次的点击，如此行为，持续了10秒。
> 压力测试：提升用户数、提升持续时间
* 配置：
  - 线程数：100
  - Ramp-up时间（秒）：1
  - 循环次数：勾选永远
  - 调度器：勾选
    - 持续时间（秒）：10
* 讲解：1秒启动100个线程，100个线程同时发起请求，每个线程每次发1条请求，当对应线程的对应请求响应后，对应线程则继续发下一条请求。直到压完10秒。

#### jmeter报错
* 并发不高，但是请求对应的响应依然出错了，是网络的问题，换成手机热点后，没再出错。
  - org.apache.http.conn.ConnectTimeoutException
  - java.net.SocketTimeoutException: Read timed out
* 这个问题的原因是windows端口被耗尽了（默认1024-5000），而且操作系统要2~4分钟才会重新释放这些端口，所以可以增加windows的可用端口来解决，windows端口最大数为65535。
  - address already in use

## 案例
#### 松下uat支付接口压测
* 流程比对：https://modao.cc/flow/BMLwhp0rkyt8vFdFNrJLf
  - uat环境，使用五五开测试环境的支付，支付接口平均1.5秒，比上周六慢。其原因是：五五开服务对应的数据库从内网本地数据库变成了外网的云数据库，增加了带宽消耗（...TODO 请拿出证据）。
    - 真的是因为内外网的原因么？有可能是其他原因么？等待排查...TODO
  - 压测环境，使用五五开测试环境的支付，支付接口平均1.1秒，比uat环境快。其原因是：压测环境的松下服务器配置很好，所以松下服务器与客户端通信的时间以及松下服务器与五五开通信的时间有所缩减，节省了些许时间。
  - 正式环境，使用五五开正式环境的支付，支付接口平均600毫秒，比上述两者都快。其原因是：1、正式环境的松下服务器配置很好。2、五五开正式环境的配置很好。
* 配置：
  - 线程数：30
  - Ramp-up时间（秒）：1
  - 循环次数：1

## 单台jmeter客户端
* 单台jmeter客户端模拟200个用户从进入小程序到预览订单。持续10分钟。于此同时用这台客户端模拟200个用户从进入小程序到下单。
* 如果模拟400个人时，单台jmeter客户端不报错，那么就直接模拟。如果报错，那就用两台jmeter客户端去分别模拟。
* 压测期间，看云数据库的运行情况，看云服务器的运行情况。
