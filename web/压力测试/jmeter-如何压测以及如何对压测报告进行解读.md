# jmeter-如何压测以及如何对压测报告进行解读
> 下述均为个人心得，仅供参考。

## 场景假设：假设直播室陆陆续续已经进入了4万人
> 我个人认为，压测应该根据具体的场景进行压测。
* 场景1：当主播喊抢购时，有n个人瞬间从直播室进入到了商详页。
* 场景2：当主播正常直播时，时不时有n个人从直播室进入到了商详页。

## 压测目的：针对上述两种场景
* 需要找出当n为多少时，系统能以最佳的状态提供服务？
* 需要找出当n为多少时，系统逐渐开始扛不住以至于崩溃？

## 压测流程：针对上述两种场景
* 1、先对场景1进行压测，找出系统能支持的最佳并发线程数。此为并发测试。
* 2、jmeter的线程数设置为最佳并发线程数时，对场景2进行压测，看系统长期运行下是否平稳。此为稳定性测试。
* 3、jmeter的线程数设置超过最佳并发线程数时，对场景2进行压测，看系统长期运行下是否平稳。此为负载测试。

## 并发测试之如何找出最佳并发线程数？
* 因进入详情页会打2个接口，所以新建1个线程组，组中配置2个请求，1个是商详接口，1个是购物车数量接口。
* 线程组启动时间设置为1秒钟。线程数分别设置为1、10、30、50、100、300、500、1000。即模拟1秒钟内有1、10、30、50、100、300、500、1000人进入商详页。
* 然后配合线程数观测每次报告总体的平均响应时间和吞吐量。你会发现，吞吐量和线程数是成正比的。当这个比例出现明显的下降时，说明拐点到了。
* 则拐点之前的线程数就是最佳并发线程数。假设这个最佳并发线程数的值是1000。那也就是说，当有1000个人同时访问商详时，系统可以无压力处理。
* 继续增大线程数，假设增大到2000时，平均响应时间是2000毫秒，但并没有出错，表示系统可以处理，但会处理的很慢。平均2秒才能处理完一次请求。毕竟人多，需要排队。
* 继续增大线程数，假设增大到3000时，平均响应时间是3000毫秒，且出现了错误，表示系统可以处理，但不仅处理的慢还会处理出问题。毕竟处理的事情太多，是会容易出错。

## 如果想要支持更高的瞬间并发，应该加多少台服务器？
* 已知最佳并发线程数是1000。临界并发线程数是2000。出错并发线程数是3000。
* 如果系统想要支撑直播间十分之一的人也就是4000人瞬间涌入商详且系统能以最佳状态处理。那么按比例推算，服务器数量需要翻4倍。
* 如果系统想要支撑直播间十分之一的人也就是4000人瞬间涌入商详且系统能以临界状态处理。那么按比例推算，服务器数量需要翻2倍。
* 注意事项：服务器翻倍后，流量会涌入对应的云数据库，则数据库也需要做对应的升级。至于升级到多少，需要看压测时，数据库的cpu使用情况进行推测。
  - 假设线程数是1000时，数据库cpu使用到了30%。
  - 假设线程数是2000时，数据库cpu使用到了60%。
  - 升级后已支持到4000的线程数，数据库应该升级到多少？我不知道怎么算！我感觉需要在原有数据库的基础上升级20%！总之要使两者处于均衡状态！

## 如果想要支持更高的稳定并发，应该加多少台服务器？
* 根据稳定性测试报告，找出最佳并发线程数或临界并发线程数进行推算。

## 如果想要支持更高的负载并发，应该加多少台服务器？
* 根据负载测试报告，找出临界并发线程数进行推算。

## 压测通用指标
* 1、接口的错误率不超过1%。
* 2、接口的平均响应时间不超过2秒。
* 3、云服务器和云数据库的cpu使用率不超过80%。
* 4、云服务器和云数据库的内存使用率不超过80%。

## 可能遇到的问题
* 1、压测机的性能很差，压不出服务器的瓶颈。例如我的笔记本电脑，开到70线程时，jmeter本身就开始出现错误，导致压测结果失真。
  - 压测机的性能越好，能带动的线程数则越多。例如我公司的台式机，线程开到1000时能正常运行。
  - 压测机的性能越差，能带动的线程数则越少。例如我的笔记本电脑，线程开到1000时，压测一启动，cpu就飙到了100%。
  - 解决方案：换台性能好的压测机。
* 2、压测机网络很差，导致平均响应时间很慢。吞吐量也很低。例如我使用被限速后的手机热点进行压测时，数据惨不忍睹。
  - 解决方案：换个网速快且稳定的网络。
* 3、当需要模拟上万并发时，单台jmeter的线程数肯定是不够用的，就算够用，cpu也支撑不了。
  - 解决方案：采用分布式压测，使用多台电脑进行同时压测。
